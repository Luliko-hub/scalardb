<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Getting started - Scalar DB Docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Getting started";
    var mkdocs_page_input_path = "getting-started.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Scalar DB Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How to use</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Getting started</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#getting-started-with-scalar-db-v1">Getting Started with Scalar DB v1</a></li>
    

    <li class="toctree-l3"><a href="#overview">Overview</a></li>
    

    <li class="toctree-l3"><a href="#install-prerequisites">Install prerequisites</a></li>
    

    <li class="toctree-l3"><a href="#build">Build</a></li>
    

    <li class="toctree-l3"><a href="#set-up-database-schema">Set up database schema</a></li>
    

    <li class="toctree-l3"><a href="#store-retrieve-data-with-storage-service">Store &amp; retrieve data with storage service</a></li>
    

    <li class="toctree-l3"><a href="#store-retrieve-data-with-transaction-service">Store &amp; retrieve data with transaction service</a></li>
    

    <li class="toctree-l3"><a href="#further-documentation">Further documentation</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../schema/">Database schema</a>
                </li>
                <li class="">
                    
    <a class="" href="../schema-loader/">Schema loader</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../design/">Design</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../jepsen/">Jepsen</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Scalar DB Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>How to use &raquo;</li>
        
      
    
    <li>Getting started</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/scalar-labs/scalardb/edit/master/docs/getting-started.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="getting-started-with-scalar-db-v1">Getting Started with Scalar DB v1</h2>
<h2 id="overview">Overview</h2>
<p>Scalar DB v1 is a library that provides a distributed storage abstraction and client-coordinated distributed transaction on the storage.
This document briefly explains how you can get started with Scalar DB with a simple electronic money application.</p>
<h2 id="install-prerequisites">Install prerequisites</h2>
<p>Scalar DB v1 is written in Java and uses Cassandra as an underlining storage implementation, so the following software is required to run it.</p>
<ul>
<li><a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">Oracle JDK 8</a> (OpenJDK 8) or higher</li>
<li><a href="http://cassandra.apache.org/">Casssandra</a> 3.11.x (the current stable version as of writing)<ul>
<li>Take a look at <a href="http://cassandra.apache.org/download/">this document</a> for how to set up Cassandra.</li>
<li>Change <code>commitlog_sync</code> from <code>periodic</code> to <code>batch</code> in <code>cassandra.yaml</code> not to lose data when quorum of replica nodes go down</li>
</ul>
</li>
<li>Other libraries used from the above are automatically installed through gradle</li>
</ul>
<p>In addition to the above, the following software is needed to use schema tools.</p>
<ul>
<li>make</li>
<li><a href="https://golang.org/">Golang</a></li>
</ul>
<p>From here, we assume Oracle JDK 8, Cassandra 3.11.x, make and Golang are properly installed in your local environment, and Cassandra is running in your localhost.</p>
<h2 id="build">Build</h2>
<p>For building Scalar DB, what you will need to do is as follows.</p>
<pre><code>$ SCALARDB_HOME=/path/to/scalardb
$ cd $SCALARDB_HOME
$ ./gradlew installDist
$ sudo mkdir /var/log/scalar; sudo chmod 777 /var/log/scalar
$ cd tools/schema
$ make
$ cd -
</code></pre>

<p>Or you can download from <a href="https://mvnrepository.com/artifact/com.scalar-labs/scalardb">maven central repository</a>.
For example in Gradle, you can add the following dependency to your build.gradle.</p>
<pre><code>dependencies {
    compile group: 'com.scalar-labs', name: 'scalardb', version: '1.0.0-rc1'
}
</code></pre>

<p>Let's move to the <code>getting-started</code> directory so that we can avoid too much copy-and-paste.</p>
<pre><code>$ cd docs/getting-started
</code></pre>

<h2 id="set-up-database-schema">Set up database schema</h2>
<p>First of all, you need to define how the data will be organized (a.k.a database schema) in the application with Scalar DB database schema.
Here is a database schema for the sample application. For the supported data types, please see <a href="../schema/">this doc</a> for more details.</p>
<pre><code class="sql">REPLICATION FACTOR 1;

CREATE NAMESPACE emoney;

CREATE TABLE emoney.account (
    id TEXT PARTITIONKEY,
    balance INT,
);
</code></pre>

<p>To load the schema file, please run the following command.</p>
<pre><code>$ $SCALARDB_HOME/tools/schema/loader emoney-storage.sdbql
</code></pre>

<h2 id="store-retrieve-data-with-storage-service">Store &amp; retrieve data with storage service</h2>
<p><a href="src/main/java/sample/ElectronicMoneyWithStorage.java"><code>ElectronicMoneyWithStorage.java</code></a>
is a simple electronic money application with storage service.
(Be careful: it is simplified for ease of reading and far from practical and is certainly not production-ready.)</p>
<pre><code class="java">public class ElectronicMoneyWithStorage extends ElectronicMoney {
  private final StorageService service;

  public ElectronicMoneyWithStorage() {
    Injector injector = Guice.createInjector(new StorageModule(new DatabaseConfig(props)));
    service = injector.getInstance(StorageService.class);
    service.with(NAMESPACE, TABLENAME);
  }

  @Override
  public void charge(String id, int amount) throws ExecutionException {
    // Retrieve the current balance for id
    Get get = new Get(new Key(new TextValue(ID, id)));
    Optional&lt;Result&gt; result = service.get(get);

    // Calculate the balance
    int balance = amount;
    if (result.isPresent()) {
      int current = ((IntValue) result.get().getValue(BALANCE).get()).get();
      balance += current;
    }

    // Update the balance
    Put put = new Put(new Key(new TextValue(ID, id))).withValue(new IntValue(BALANCE, balance));
    service.put(put);
  }

  @Override
  public void pay(String fromId, String toId, int amount) throws ExecutionException {
    // Retrieve the current balances for ids
    Get fromGet = new Get(new Key(new TextValue(ID, fromId)));
    Get toGet = new Get(new Key(new TextValue(ID, toId)));
    Optional&lt;Result&gt; fromResult = service.get(fromGet);
    Optional&lt;Result&gt; toResult = service.get(toGet);

    // Calculate the balances (it assumes that both accounts exist)
    int newFromBalance = ((IntValue) (fromResult.get().getValue(BALANCE).get())).get() - amount;
    int newToBalance = ((IntValue) (toResult.get().getValue(BALANCE).get())).get() + amount;
    if (newFromBalance &lt; 0) {
      throw new RuntimeException(fromId + &quot; doesn't have enough balance.&quot;);
    }

    // Update the balances
    Put fromPut =
        new Put(new Key(new TextValue(ID, fromId)))
            .withValue(new IntValue(BALANCE, newFromBalance));
    Put toPut =
        new Put(new Key(new TextValue(ID, toId))).withValue(new IntValue(BALANCE, newToBalance));
    service.put(fromPut);
    service.put(toPut);
  }

  @Override
  public void close() {
    service.close();
  }
}
</code></pre>

<p>Now we can run the application.</p>
<pre><code>$ ../../gradlew run --args=&quot;-mode storage -action charge -amount 1000 -to user1&quot;
$ ../../gradlew run --args=&quot;-mode storage -action charge -amount 0 -to merchant1&quot;
$ ../../gradlew run --args=&quot;-mode storage -action pay -amount 100 -to merchant1 -from user1&quot;
</code></pre>

<h2 id="store-retrieve-data-with-transaction-service">Store &amp; retrieve data with transaction service</h2>
<p>The previous application seems fine under ideal conditions, but it is problematic when some failure happens during its operation or when multiple operations occur at the same time because it is not transactional.
For example, money transfer (pay) from <code>A's balance</code> to <code>B's balance</code> is not done atomically in the application, and there might be a case where only <code>A's balance</code> is decreased (and <code>B's balance</code> is not increased) if a failure happens right after the first <code>put</code> and some money will be lost.</p>
<p>With the transaction capability of Scalar DB, we can make such operations to be executed with ACID properties.
Before updating the code, we need to update the schema to make it transaction capable by adding <code>TRANSACTION</code> keyword in <code>CREATE TABLE</code>.</p>
<pre><code class="sql">REPLICATION FACTOR 1;

CREATE NAMESPACE emoney;

CREATE TRANSACTION TABLE emoney.account (
    id TEXT PARTITIONKEY,
    balance INT,
);
</code></pre>

<p>Before reapplying the schema, please drop the existing namespace first by issuing the following.
(Sorry you need to issue implementation specific commands to do this.)</p>
<pre><code>$ cqlsh -e &quot;drop keyspace emoney&quot;
$ $SCALARDB_HOME/tools/schema/loader emoney-transaction.sdbql
</code></pre>

<p>Now we can update the code as follows to make it transactional.</p>
<pre><code class="java">public class ElectronicMoneyWithTransaction extends ElectronicMoney {
  private final TransactionService service;

  public ElectronicMoneyWithTransaction() {
    Injector injector = Guice.createInjector(new TransactionModule(new DatabaseConfig(props)));
    service = injector.getInstance(TransactionService.class);
    service.with(NAMESPACE, TABLENAME);
  }

  @Override
  public void charge(String id, int amount)
      throws CrudException, CommitException, UnknownTransactionStatusException {
    // Start a transaction
    DistributedTransaction tx = service.start();

    // Retrieve the current balance for id
    Get get = new Get(new Key(new TextValue(ID, id)));
    Optional&lt;Result&gt; result = tx.get(get);

    // Calculate the balance
    int balance = amount;
    if (result.isPresent()) {
      int current = ((IntValue) result.get().getValue(BALANCE).get()).get();
      balance += current;
    }

    // Update the balance
    Put put = new Put(new Key(new TextValue(ID, id))).withValue(new IntValue(BALANCE, balance));
    tx.put(put);

    // Commit the transaction (records are automatically recovered in case of failure)
    tx.commit();
  }

  @Override
  public void pay(String fromId, String toId, int amount)
      throws CrudException, CommitException, UnknownTransactionStatusException {
    // Start a transaction
    DistributedTransaction tx = service.start();

    // Retrieve the current balances for ids
    Get fromGet = new Get(new Key(new TextValue(ID, fromId)));
    Get toGet = new Get(new Key(new TextValue(ID, toId)));
    Optional&lt;Result&gt; fromResult = tx.get(fromGet);
    Optional&lt;Result&gt; toResult = tx.get(toGet);

    // Calculate the balances (it assumes that both accounts exist)
    int newFromBalance = ((IntValue) (fromResult.get().getValue(BALANCE).get())).get() - amount;
    int newToBalance = ((IntValue) (toResult.get().getValue(BALANCE).get())).get() + amount;
    if (newFromBalance &lt; 0) {
      throw new RuntimeException(fromId + &quot; doesn't have enough balance.&quot;);
    }

    // Update the balances
    Put fromPut =
        new Put(new Key(new TextValue(ID, fromId)))
            .withValue(new IntValue(BALANCE, newFromBalance));
    Put toPut =
        new Put(new Key(new TextValue(ID, toId))).withValue(new IntValue(BALANCE, newToBalance));
    tx.put(fromPut);
    tx.put(toPut);

    // Commit the transaction (records are automatically recovered in case of failure)
    tx.commit();
  }

  @Override
  public void close() {
    service.close();
  }
}
</code></pre>

<p>As you can see, it's not very different from the code with <code>StorageService</code>.
This code instead uses <code>TransactionService</code> and all the CRUD operations are done through the <code>DistributedTransaction</code> object returned from <code>TransactionService.start()</code>.</p>
<p>Now let's run the application with transaction mode.</p>
<pre><code>$ ../../gradlew run --args=&quot;-mode transaction -action charge -amount 1000 -to user1&quot;
$ ../../gradlew run --args=&quot;-mode transaction -action charge -amount 0 -to merchant1&quot;
$ ../../gradlew run --args=&quot;-mode transaction -action pay -amount 100 -to merchant1 -from user1&quot;
</code></pre>

<h2 id="further-documentation">Further documentation</h2>
<p>These are just simple examples of how Scalar DB is used. For more information, please take a look at the following documents.</p>
<ul>
<li><a href="../design/">Design Document</a></li>
<li><a href="https://scalar-labs.github.io/scalardb/javadoc/">Javadoc</a></li>
<li><a href="../schema/">Database schema in Scalar DB</a></li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../schema/" class="btn btn-neutral float-right" title="Database schema">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/scalar-labs/scalardb/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../schema/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
